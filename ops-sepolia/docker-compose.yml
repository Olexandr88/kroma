version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.

volumes:
  l2_data:
  kroma_log:

services:
  l2:
    image: kromanetwork/geth:answer
    ports:
      - "9545:8545"
      - "9546:8546"
    environment:
      CHAIN_ID: 901
      GETH_MINER_RECOMMIT: 100ms
    volumes:
      - "l2_data:/db"
      - "${PWD}/entrypoint-l2.sh:/entrypoint.sh"
      - "${PWD}/../.devnet/genesis-l2.json:/genesis.json"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
    entrypoint: # pass the L2 specific flags by overriding the entry-point and adding extra arguments
      - "/bin/sh"
      - "/entrypoint.sh"
      - "--authrpc.jwtsecret=/config/test-jwt-secret.txt"
      - "--KromaZKTrie=false"
      - "--snapshot=false"

  kroma-node:
    depends_on:
      - l2
    image: kromanetwork/node:answer
    build:
      context: ..
      target: "op-node"
    environment:
      NODE_L1_ETH_RPC: https://api-l1.sepolia.kroma.network
      NODE_L2_ENGINE_RPC: http://l2:8551
      NODE_L2_ENGINE_AUTH: /config/test-jwt-secret.txt
      NODE_ROLLUP_CONFIG: /rollup.json
      NODE_RPC_ADDR: 0.0.0.0
      NODE_RPC_PORT: 8545
      NODE_RPC_ENABLE_ADMIN: true
      NODE_L1_BEACON: https://api-l1-beacon.sepolia.kroma.network
      NODE_SNAPSHOT_LOG: /kroma_log/snapshot.log
      NODE_SEQUENCER_ENABLED: false
      NODE_SEQUENCER_L1_CONFS: 0
      NODE_VERIFIER_L1_CONFS: 0
      NODE_P2P_DISABLE: true
      NODE_P2P_LISTEN_IP: 0.0.0.0
      NODE_P2P_LISTEN_TCP_PORT: 9003
      NODE_P2P_LISTEN_UDP_PORT: 9003
      NODE_P2P_PEER_SCORING: light
      NODE_P2P_PEER_BANNING: true
      NODE_P2P_PRIV_PATH: /config/p2p-node-key.txt
      NODE_P2P_SEQUENCER_KEY: 8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
      NODE_METRICS_ENABLED: true
      NODE_METRICS_ADDR: 0.0.0.0
      NODE_METRICS_PORT: 7300
      NODE_PPROF_ENABLED: true
    ports:
      - "7545:8545"
      - "9003:9003"
      - "7300:7300"
      - "6060:6060"
    volumes:
      - "${PWD}/p2p-sequencer-key.txt:/config/p2p-sequencer-key.txt"
      - "${PWD}/p2p-node-key.txt:/config/p2p-node-key.txt"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
      - "${PWD}/../.devnet/rollup.json:/rollup.json"
      - kroma_log:/kroma_log
